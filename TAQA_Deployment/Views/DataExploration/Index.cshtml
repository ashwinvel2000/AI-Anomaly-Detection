@{
    Layout = "_Layout";           /* keep the normal navbar */
}

@section Styles {
    <!-- DataTables CSS (CDN) -->
    <link rel="stylesheet"
          href="https://cdn.datatables.net/1.13.10/css/jquery.dataTables.min.css" />

    <link rel="stylesheet"
          href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css" />
}

<h2 class="text-center my-4">Explore DataHub Streams</h2>

<!-- 🔍 FILTER BAR -->
<div class="container mb-3">
    <div class="row g-3 align-items-end">

        <div class="col-6 col-md-3">
            <label class="form-label">Tool ID</label>
            <input id="tool" class="form-control" placeholder="e.g. P8-1" />
        </div>

        <div class="col-6 col-md-2">
            <label class="form-label">Kind</label>
            <select id="kind" class="form-select">
                <option value="">Any</option>
                <option>SIT</option>
                <option>LOG</option>
                <option>WELL</option>
                <option>WG</option>
            </select>
        </div>

        <div class="col-12 col-md-4">
            <label class="form-label">Data-type keywords<br><small>(comma-separated)</small></label>
            <input id="types" class="form-control" placeholder="Battery-Voltage,CPU-Temperature">
        </div>

        <div class="col-4 col-md-1">
            <label class="form-label">Days</label>
            <input id="days" type="number" value="180" min="1" class="form-control">
        </div>

        <div class="col-4 col-md-2 d-grid">
            <button id="apply" class="btn btn-primary">Apply</button>
        </div>

    </div>
</div>

<!-- ⏳ SPINNER -->
<div class="text-center my-3" id="loadingSpinner" style="display:none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading…</span>
    </div>
</div>

<!-- 📊 TABLE -->
<div class="container">
    <table id="summaryTable" class="display w-100">
        <thead>
            <tr>
                <th>Stream Id</th>
                <th>Start UTC</th>
                <th>End UTC</th>     
                <th>Total Pts</th>
                <th>Rows</th>
                <th>Min</th>
                <th>Max</th>
                <th>Mean</th>
                <th>Std</th>
                <th>Median Δt (s)</th>
                <th>% missing</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

@section Scripts {
    <!-- jQuery & DataTables JS (CDN) -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.10/js/jquery.dataTables.min.js"></script>

    <!-- Buttons extension (CDN) -->
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    


    <script>
        function dtUtc (data) {
            if (!data) return '';
            return new Date(data).toLocaleString();   // adapts to user locale
        }


        function pctFmt (data) {
            return data === null || data === undefined ? '' : (data.toFixed(1) + ' %');
        }
        /* initialise empty table once */
        const table = $('#summaryTable').DataTable({
            paging: true,
            searching: true,

            dom: 'Bfrtip',                 // B = Buttons, f = filter, r, t, i, p
            buttons: [
              {
                extend: 'csv',
                text: 'Export CSV',
                filename: 'streamSummary_'+ new Date().toISOString().slice(0,10), 
                title: null                 // keeps the header row only
              }
            ],

            columns: [
              { data: 'streamId' },
              { data: 'startUtc',  render: dtUtc },
              { data: 'endUtc',    render: dtUtc },
              { data: 'pointCount', className: 'text-end' },
              { data: 'count' },
              { data: 'min',  render: $.fn.dataTable.render.number(',', '.', 2) },
              { data: 'max',  render: $.fn.dataTable.render.number(',', '.', 2) },
              { data: 'mean', render: $.fn.dataTable.render.number(',', '.', 2) },
              { data: 'stdD',  render: $.fn.dataTable.render.number(',', '.', 2) },
              { data: 'medianDtSecs', className: 'text_end' },
              { data: 'pctMissing',
                render: d => d.toFixed(1) + '%' }
            ],
            rowCallback: function(row, data){
                if (data.pctMissing > 5) $(row).addClass('table-warning');
            }
        });

        async function refresh(){
            $('#loadingSpinner').show();     // 👀 spinner on
            const url = `/Explore/List?tool=${$('#tool').val()}`
                        + `&kind=${$('#kind').val()}`
                        + `&types=${$('#types').val()}`
                        + `&days=${$('#days').val()}`;
            const res  = await fetch(url);
            const rows = await res.json();
            table.clear().rows.add(rows.data).draw();
            $('#loadingSpinner').hide();     // ✅ spinner off
        }
        $('#apply').on('click', refresh);
    </script>
}
